<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘</title>
<style>
body { margin:0; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; background:#f0f0f0; padding:10px; user-select:none; }
h1{ font-size:24px; margin:10px 0; }
#controls{ display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:20px; }
.flag-options{ display:flex; gap:15px; justify-content:center; }
label{ font-size:24px; cursor:pointer; display:flex; align-items:center; }
input[type="radio"]{ transform:scale(1.5); cursor:pointer; margin-right:5px; }
button{ padding:12px 24px; font-size:18px; border:none; border-radius:5px; cursor:pointer; background:#2196f3; color:white; }
#status{ font-size:18px; font-weight:bold; margin-top:10px; }
#board{ display:grid; gap:2px; box-sizing:border-box; margin:0 auto; transition:all 0.2s ease-in-out; }
.cell{ background:#bbb; display:flex; align-items:center; justify-content:center; font-size:16px; font-weight:bold; color:#333; border-radius:3px; cursor:pointer; transition:background-color 0.2s; aspect-ratio:1/1; user-select:none; }
.cell.open{ background:#e0e0e0; }
.cell.flag{ background:#ffeb3b; }
.cell.mine{ background:#f44336; color:white; }
.timer{ font-size:20px; font-weight:bold; margin-top:10px; }
</style>
</head>
<body>
<h1>ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ï¼ˆå½æ•°å­—ãƒ»é‡çˆ†å¼¾å¯¾å¿œï¼‰</h1>

<div id="controls">
  <button id="resetButton">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
  <div style="display:flex;gap:10px;align-items:center;">
    <label style="font-size:18px;">ãƒ’ãƒ³ãƒˆç¢ºç‡:<input id="hintInput" type="number" value="10" min="0" max="100" style="width:60px;">%</label>
    <label style="font-size:18px;">å½æ•°å­—ç¢ºç‡:<input id="bluffInput" type="number" value="50" min="0" max="100" style="width:60px;">%</label>
  </div>
  <div class="flag-options">
    <label><input type="radio" name="flag" value="ğŸš©">ğŸš©</label>
    <label><input type="radio" name="flag" value="âš ï¸">âš ï¸</label>
    <label><input type="radio" name="flag" value="â˜¢ï¸">â˜¢ï¸</label>
  </div>
  <div style="display:flex;gap:10px;">
    <button onclick="saveBoard()">ğŸ’¾ ã‚»ãƒ¼ãƒ–</button>
    <button onclick="loadBoard()">ğŸ“‚ ãƒ­ãƒ¼ãƒ‰</button>
  </div>
</div>

<div id="status"></div>
<div id="board"></div>
<div id="timer" class="timer">æ™‚é–“:0</div>

<script>
const size=20, mineCount=100;
let board=[], gameOver=false, openedCount=0, timer, timerSeconds=0,
    firstClick=null, selectedFlag=null, hintRate=10, bluffRate=50;
const boardEl=document.getElementById("board"),
      statusEl=document.getElementById("status"),
      timerEl=document.getElementById("timer");

document.getElementById("resetButton").addEventListener("click",()=>{if(confirm("æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) init();});
document.querySelectorAll('input[name="flag"]').forEach(r=>{r.addEventListener('click',e=>{if(selectedFlag===e.target.value){e.target.checked=false;selectedFlag=null;}else selectedFlag=e.target.value;});});

function init(){
  hintRate=Number(document.getElementById("hintInput").value)||10;
  bluffRate=Number(document.getElementById("bluffInput").value)||50;

  board=[]; gameOver=false; openedCount=0; firstClick=null;
  statusEl.textContent=''; boardEl.innerHTML='';
  clearInterval(timer); timerSeconds=0; timerEl.textContent='æ™‚é–“:0';
  timer=setInterval(()=>{if(!gameOver){timerSeconds++; timerEl.textContent=`æ™‚é–“:${timerSeconds}`;}},1000);

  const short=Math.min(window.innerWidth,window.innerHeight)*0.9;
  boardEl.style.width=`${short}px`; boardEl.style.height=`${short}px`;
  boardEl.style.gridTemplateColumns=`repeat(${size},1fr)`; boardEl.style.gridTemplateRows=`repeat(${size},1fr)`;

  for(let y=0;y<size;y++){
    board[y]=[];
    for(let x=0;x<size;x++){
      const el=document.createElement('div');
      el.className='cell'; boardEl.appendChild(el);
      const cell={x,y,el,mine:null,open:false,flag:null,count:0,hint:false,deception:false};
      el.addEventListener('click',()=>handleClick(cell));
      board[y][x]=cell;
    }
  }
}

function handleClick(c){
  if(gameOver||c.open) return;
  if(selectedFlag){
    if(!c.open){
      if(c.flag===selectedFlag){c.flag=null;c.el.textContent='';c.el.classList.remove('flag');}
      else {c.flag=selectedFlag;c.el.textContent=selectedFlag;c.el.classList.add('flag');}
    }
    return;
  }
  if(c.flag) return;
  if(!firstClick){firstClick={x:c.x,y:c.y}; placeMines(); }
  openCell(c);
  if(c.mine){c.el.classList.add('mine'); c.el.textContent=c.mine==="heavy"?"ğŸ’¥":"ğŸ’£"; endGame(false); return;}
  if(c.count===0) openAround(c.x,c.y);
  if(openedCount===size*size-mineCount) endGame(true);
}

function placeMines(){
  const safe=new Set();
  for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++) safe.add(`${firstClick.x+dx},${firstClick.y+dy}`);
  let mines=0, heavyCount=Math.floor(Math.random()*(mineCount+1)), heavy=0;
  while(mines<mineCount){
    const x=Math.floor(Math.random()*size), y=Math.floor(Math.random()*size);
    const c=board[y][x];
    if(!c.mine && !safe.has(`${x},${y}`)){
      c.mine=(heavy<heavyCount)?"heavy":"normal";
      if(c.mine==="heavy") heavy++;
      mines++;
    }
  }
  for(let y=0;y<size;y++) for(let x=0;x<size;x++){
    const c=board[y][x];
    if(!c.mine) c.count=getCount(x,y);
    // â˜… ç›¤é¢ç”Ÿæˆæ™‚ã«ãƒ’ãƒ³ãƒˆã¨å½æ•°å­—ã‚’æŠ½é¸
    c.deception=Math.random()<bluffRate/100;
    c.hint=Math.random()<hintRate/100;
  }
}

function getCount(x,y){
  let n=0;
  for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
    const nx=x+dx, ny=y+dy;
    if(nx>=0 && ny>=0 && nx<size && ny<size){
      const m=board[ny][nx].mine;
      if(m==="normal") n++; else if(m==="heavy") n+=2;
    }
  }
  return n;
}

function openCell(c){
  if(c.open) return; c.open=true; openedCount++;
  c.el.classList.add('open'); c.el.classList.remove('flag');

  if(c.count>0){
    const displayNumber=c.deception?Math.max(1,c.count-1):c.count;
    c.el.textContent=displayNumber;
    c.el.style.color=getColor(c.count);
    if(c.hint) c.el.style.backgroundColor="#e8d5ff";
  }
}

function openAround(x,y){
  for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
    if(!dx&&!dy) continue;
    const nx=x+dx, ny=y+dy;
    if(nx>=0 && ny>=0 && nx<size && ny<size){
      const n=board[ny][nx];
      if(!n.open && !n.mine && !n.flag){
        openCell(n);
        if(n.count===0) openAround(nx,ny);
      }
    }
  }
}

function getColor(n){
  return ['#000','#1976d2','#388e3c','#d32f2f','#512da8','#ffa000','#00796b','#000','#7b1fa2'][n]||'#000';
}

function endGame(win){
  gameOver=true; clearInterval(timer);
  if(win) statusEl.textContent=`ğŸ‰ å‹åˆ©ï¼ æ™‚é–“:${timerSeconds}ç§’`;
  else{
    statusEl.textContent="ğŸ’¥ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼";
    for(let y=0;y<size;y++) for(let x=0;x<size;x++){
      const c=board[y][x];
      if(c.mine && !c.open){c.el.classList.add('mine'); c.el.textContent=c.mine==="heavy"?"ğŸ’¥":"ğŸ’£";}
    }
  }
}

// â˜… ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰ã§ hint/deception/count ã‚‚å®Œå…¨ä¿å­˜
const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
function saveBoard(){
  if(!firstClick) return alert("ç›¤é¢æœªç”Ÿæˆã§ã™");
  let bits="";
  for(let y=0;y<size;y++) for(let x=0;x<size;x++){
    const c=board[y][x];
    const m=c.mine==="heavy"?2:c.mine==="normal"?1:0;
    const d=c.deception?1:0;
    const h=c.hint?1:0;
    const o=c.open?1:0;
    const f=c.flag==="ğŸš©"?1:c.flag==="âš ï¸"?2:c.flag==="â˜¢ï¸"?3:0;
    bits+=m.toString(2).padStart(2,'0')+d+h+o+f.toString(2).padStart(2,'0');
  }
  while(bits.length%6) bits+="0";
  let s="";
  for(let i=0;i<bits.length;i+=6) s+=chars[parseInt(bits.slice(i,i+6),2)];
  prompt("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„",s);
}

function loadBoard(){
  const s=prompt("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if(!s) return;
  let bits="";
  for(const ch of s){
    const v=chars.indexOf(ch);
    if(v<0) return alert("ä¸æ­£ãªæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™");
    bits+=v.toString(2).padStart(6,'0');
  }
  const expectedBits=size*size*6;
  if(bits.length<expectedBits){alert("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒçŸ­ã™ãã¾ã™"); return;}
  init();
  let i=0;
  const data=[];
  for(let y=0;y<size;y++) for(let x=0;x<size;x++){
    const m=parseInt(bits.slice(i,i+2),2); i+=2;
    const d=bits[i++]==="1";
    const h=bits[i++]==="1";
    const o=bits[i++]==="1";
    const f=parseInt(bits.slice(i,i+2),2); i+=2;
    data.push({x,y,m,d,h,o,f});
  }

  for(const d of data){
    const c=board[d.y][d.x];
    if(d.m===1) c.mine="normal"; else if(d.m===2) c.mine="heavy";
    c.count=getCount(d.x,d.y);
    c.deception=d.d;
    c.hint=d.h;
  }

  for(const d of data){
    const c=board[d.y][d.x];
    if(d.f){ c.flag=["","ğŸš©","âš ï¸","â˜¢ï¸"][d.f]; c.el.textContent=c.flag; c.el.classList.add('flag');}
    if(d.o){ openCell(c);}
  }

  statusEl.textContent="ãƒ­ãƒ¼ãƒ‰å®Œäº† âœ…";
}

init();
</script>
</body>
</html>
